---
import twemoji from "@twemoji/api";
import Path from "path";
import "zenn-content-css";
import Articles from "../../components/Articles.astro";
import Layout from "../../layouts/Layout.astro";
import { getArticleList, markdownToHtmlNormalized } from "../../lib/zenn";

export const getStaticPaths = async () => {
  const articles = await getArticleList();
  const types = articles.flatMap((article) => article.frontmatter.type ?? []);
  const topics = articles.flatMap((article) => article.frontmatter.topics ?? []);
  return [...new Set([...topics, ...types])].map((topic) => {
    const data = articles.filter((article) => {
      const articleTopics = article.frontmatter.topics ?? [];
      return articleTopics.includes(topic) || article.frontmatter.type === topic;
    });

    return {
      params: { topic },
      props: {
        emoji: "#âƒ£",
        data: data.map((article) => {
          const html = markdownToHtmlNormalized(article.rawContent());
          return {
            slug: Path.basename(article.file, ".md"),
            topics: article.frontmatter.topics,
            title: article.frontmatter.title,
            emoji: article.frontmatter.emoji,
            type: article.frontmatter.type,
          };
        }),
      },
    };
  });
};

const { topic } = Astro.params;
const { data, emoji } = Astro.props;
---

<Layout>
  <header>
    <div class="center">
      {
        emoji && (
          <div
            class="header-emoji"
            set:html={twemoji.parse(emoji!, { folder: "svg", ext: ".svg" })}
          />
        )
      }
      <h1>
        {topic}
      </h1>
    </div>
  </header>
  <main class="center">
    <section>
      <h2>Articles</h2>
      <Articles type="list" data={data} />
    </section>
  </main>
</Layout>

<style>
  header {
    background-color: #ffffff;
    padding: 40px 0;
  }

  header > .center {
    display: flex;
    flex-direction: row;
  }

  .header-emoji {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 1.7rem;
    border: 1px solid #e4edf4;
  }

  @media (max-width: 375px) {
    .header-emoji {
      display: none;
    }
  }
</style>
