---
title: "TwitterのAPIの話"
emoji: "😎"
type: "tech"
topics: ["twitter"]
published: false
---

## Twitter の API の話

Twitter の Web クライアントが内部で使っている API について調べてみました。
独自で Twitter のクライアントを作ろうとしている同志は、参考にしてください。

### graphql と v1.1 と v2

Twitter の API は`v1.1`, `v2`, `graphql` の 3 つのエンドポイントあります。`v1.1`, `v2` は RESTful API で、`graphql` は GraphQL の皮を被った独自 API です。
`v1.1`, `v2` はイーロンマスクが介入する前に無料で使えた API で、`graphql` は内部でのみ利用されています。
`v1.1`, `v2` も過去には内部で利用されていましたが、現在はほとんど `graphql` に移行されています。全てが `graphql` に移行されているわけではありません。

`v1.1` は過去に仕様が公開されており調べたらすぐに出てくるので、今回は `graphql` を使って Twitter のクライアントを作ります。

### graphql のエンドポイント

`https://twitter.com/i/api/graphql/` が graphql のエンドポイントです。
このエンドポイントに GET か POST でリクエストを送ることで、Twitter のデータを取得できます。

パスパラメータには、`queryId`と`name`が必要です。
`https://twitter.com/i/api/graphql/{queryId}/{name}`

- `queryId` はバージョンによって異なる、英数字の文字列です。
- `name` はクエリの名前です。

パラメータには、`queryId`, `variables`, `features`, `fieldToggles` が必要です。
`variables`, `features`, `fieldToggles` は json にエンコードして、文字列として含める必要があります。POST リクエストの場合は、`Content-Type: application/json` でリクエストを送るため、2 重で json にエンコードする必要があります。

- `queryId` はバージョンによって異なる、英数字の文字列です。パスパラメータの`queryId`と同じです。
- `variables` は問い合わせに必要な変数です。リクエストによって変わります。
- `features` は機能フラグです。`{[key: string]: boolean}` の形式です。含まれる key はリクエストによって変わりますが、`key` に対する値は、クライアントやクライアントの情報(`User-Agent`, `IP Address`)によって変わります。この値を帰ることで、レスポンスの内容が変わります。

### ログイン

#### ゲストトークン

ログイン情報がなくても利用できる API があり、それらを呼び出すためにはゲストトークンが必要です。

##### 現在(2024 年 3 月)

1. `https://twitter.com/` にアクセスして、レスポンスのクッキーを取得します。
2. レスポンスのボディに含まれる`script`タグを解析して、`document.cookie=` で始まる行を実行して、ゲストトークンを取得します。

ただし、実際に必要なトークンは`ct0` と `gt` のみです。それ以外は、トラッキングのためのトークンです。

- `ct` は `csrf token` のこと
- `gt` は `guest token` のこと

##### それより前

基本的には今と同じですが、クッキーがセットされていない状態で `https://twitter.com/` にアクセスすると、`https://twitter.com/` にリダイレクトされていました。
利用している http クライアントが、`set-cookie` の処理よりも先にリダイレクトを処理する場合は無限にリダイレクトされるので、注意が必要です。

##### さらに前

基本的には今と同じですが、リクエストに必要な `csrf token` が含まれていないのでクライアントでランダムに生成していました。

##### さらに前

`https://api.twitter.com/1.1/guest/activate.json` に POST リクエストを送ることで、ゲストトークンを取得できました。

#### ログイン

ログインの API は、独自のエンドポイントを持っていましたが、現在は `v1.1` のエンドポイントを使っています。
複雑なログインフローを持っており、クライアントとサーバーで複数回のやり取りを行います。
同一エンドポイントに対して、`flow_token` と `subtask_inputs` というパラメータを送ることで、フローを進めることができます。

- `flow_token` はトークンで、前回のリクエストのレスポンスに含まれています。
- `subtask_inputs` は、フォームの入力値が含まれています。

レスポンスには、入力フォームを構成するための情報が含まれており、それを使ってクライアント側でフォームを構成します。

ログインに成功すると、`set-cookie` にセッション情報が含まれているので、それを使って API を利用できます。

ただし、実際に必要なトークンは`ct0` と `auth_token` のみです。それ以外は、トラッキングのためのトークンです。

また、ツイートなどを報告する API なども同様のフロー API を使っています。

#### ヘッダー

すべての API には、Bearer Token を含める必要がありますが、これらは定数です。
他にも、`x-csrf-token` や `x-guest-token` などが必要ですが、これは、上記で取得したトークンと同じです。
ログイン情報を表すヘッダーやクライアントの情報を表すヘッダーも必要です。

Twitter は `accept-encoding` がちゃんと実装されており、`gzip` が指定されている場合は、レスポンスが圧縮されて返ってきます。
HTTP クライアントによっては、自動で解答してくれないものもあるので、注意が必要です。
一応、`identity` も指定できますが、これを指定している公式クライアントがあるかどうかはわかりません。

また、`User-Agent` によって、レスポンスの内容が変わることがあるかもしれません。

### レスポンス

Twitter API のレスポンスをパースするのは、2 つの地獄が待っています。

#### instruction

ツイートが複数件返ってくる場合、`instruction` というオブジェクトが含まれます。
これは、ツイートの情報や、操作を行うための情報が含まれています。
表示が別なのにほとんどのオブジェクトが共通化されており、複雑な Union をパースする必要があります。

Twitter のツイートでは、複数のツイートが入れ子になっていることがあります。
特にリプライは複雑で、リプライのリプライがある場合、ツリー構造になっておらず、フラットな構造になっている場合があります。

`instruction` にはオススメユーザーやトレンドなどが含まれているため、ツイートの情報だけを取り出すのも複雑です。
最近、ユーザーツイートのメディア欄の表示方法が変わったため、それを再現するのも難しいです。

#### リッチテキスト

リッチテキストとは、Twitter Blue のユーザーのみが利用できる機能です。
ツイート内の文字を太文字や斜体にすることができます。
また、ツイートの本文と本文の間に、画像を挿入することができます。

リッチテキストとは別に、Twitter には、ハッシュタグやメンション、URL などをリンク化する機能があります。
URL は、自動的に短縮され、別のものに置き換えられます。また画像が、URL に置き換えられる機能があります。

これらを、クライアント側で再現するには、かなりの労力が必要です。

ハッシュタグやメンション、URL は、n 文字目から m 文字目までをリンク化する情報を含むオブジェクトが含まれています。
ただし、文字のカウント方法は `String: length` と同じで実際の Unicode 文字数に一致しません。
URL の自動短縮も同様で n 文字目から m 文字目までを xxx から yyy に置き換えるという情報が含まれています。

リッチテキストの場合も同様ですが、文字のカウント方法がサロゲートペアに対応している必要があります。
つまり、`String: length` とは別のカウント方法を使う必要があります。
URL の置き換え処理はカウントに影響されないのも注意が必要です。

### まとめ

イーロンマスクが介入する前から、Twitter はクソ
